<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail List</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’‘</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="list-page">
    <div class="container">
        <header class="list-header">
            <a href="home.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Kembali
            </a>
            <div class="list-title-container">
                <h1 id="list-title">Loading...</h1>
                <div class="list-stats">
                    <span class="stat-badge"><i class="fas fa-tasks"></i> <span id="total-items">0</span> item</span>
                    <span class="stat-badge"><i class="fas fa-check-circle"></i> <span id="completed-items">0</span> selesai</span>
                </div>
            </div>
            <button id="delete-list-btn" class="btn-delete" title="Hapus list">
                <i class="fas fa-trash-alt"></i>
            </button>
        </header>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Tambah Item Baru</h2>
                </div>
                
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-item-input" placeholder="Contoh: Nonton filmðŸŽ¬">
                        <button id="add-item-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Tambah Item
                        </button>
                    </div>
                    <!-- <p class="hint-text">Item akan langsung terlihat oleh kita berdua ðŸ’•</p> -->
                </div>
            </div>

            <div class="card items-card">
                <div class="card-header">
                    <h2><i class="fas fa-check-square"></i> Checklist Items</h2>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <span class="progress-text" id="progress-percent">0%</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="items" class="items-list"></div>
                    
                    <div id="items-empty-state" class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Yahh list nya masih kosong nihh!</h3>
                        <p>Ayoo tambahin item listnya diatas buat bikin</p>
                    </div>
                    
                    <div class="live-update">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Live update aktif - perubahan langsung tersimpan</span>
                    </div>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Dibuat</h3>
                        <p id="created-date">-</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Progress</h3>
                        <p id="completion-rate">0%</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Terakhir Update</h3>
                        <p id="updated-date">Baru saja</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast"></div>

    <script>
        // Firebase Configuration - HARUS SAMA
        const firebaseConfig = {
            apiKey: "AIzaSyC0i9FPn0-IHgG7kAnvTX6YIN356Q5ZUrM",
            authDomain: "with-you-app-8058a.firebaseapp.com",
            projectId: "with-you-app-8058a",
            storageBucket: "with-you-app-8058a.firebasestorage.app",
            messagingSenderId: "501566707158",
            appId: "1:501566707158:web:24f31d920555282bd5c077"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function() {
            // Cek login
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'index.html';
                return;
            }

            // Ambil list ID dari localStorage
            const listId = localStorage.getItem('currentListId');
            if (!listId) {
                window.location.href = 'home.html';
                return;
            }

            // DOM Elements
            const listTitle = document.getElementById('list-title');
            const totalItemsEl = document.getElementById('total-items');
            const completedItemsEl = document.getElementById('completed-items');
            const progressPercentEl = document.getElementById('progress-percent');
            const progressFill = document.getElementById('progress-fill');
            const createdDateEl = document.getElementById('created-date');
            const updatedDateEl = document.getElementById('updated-date');
            const completionRateEl = document.getElementById('completion-rate');
            const newItemInput = document.getElementById('new-item-input');
            const addItemBtn = document.getElementById('add-item-btn');
            const deleteListBtn = document.getElementById('delete-list-btn');
            const itemsContainer = document.getElementById('items');
            const itemsEmptyState = document.getElementById('items-empty-state');

            // Real-time listener untuk list
            let listUnsubscribe = null;

            // Load list data
            function loadList() {
                const listRef = db.collection('lists').doc(listId);
                
                listUnsubscribe = listRef.onSnapshot((doc) => {
                    if (!doc.exists) {
                        showToast('List tidak ditemukan!');
                        setTimeout(() => {
                            window.location.href = 'home.html';
                        }, 1500);
                        return;
                    }
                    
                    const list = doc.data();
                    list.id = doc.id;
                    
                    // Update UI
                    updateListUI(list);
                    
                    // Update last active time
                    updateLastActive();
                }, (error) => {
                    console.error("Error loading list:", error);
                    showToast('Error memuat list. Coba refresh.');
                });
            }

            // Update UI dengan data list
            function updateListUI(list) {
                // Set judul
                listTitle.textContent = list.name;
                
                // Hitung stats
                const items = list.items || [];
                const totalItems = items.length;
                const completedItems = items.filter(item => item.completed).length;
                const progressPercent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                
                // Update stats
                totalItemsEl.textContent = totalItems;
                completedItemsEl.textContent = completedItems;
                progressPercentEl.textContent = `${progressPercent}%`;
                progressFill.style.width = `${progressPercent}%`;
                completionRateEl.textContent = `${progressPercent}% Complete`;
                
                // Update dates
                if (list.createdAt) {
                    createdDateEl.textContent = formatDate(list.createdAt);
                }
                if (list.updatedAt) {
                    updatedDateEl.textContent = formatDate(list.updatedAt, true);
                }
                
                // Render items
                renderItems(items);
            }

            // Render items
            function renderItems(items) {
                if (items.length === 0) {
                    itemsEmptyState.style.display = 'block';
                    itemsContainer.style.display = 'none';
                    itemsContainer.innerHTML = '';
                } else {
                    itemsEmptyState.style.display = 'none';
                    itemsContainer.style.display = 'flex';
                    itemsContainer.innerHTML = '';
                    
                    items.forEach((item, index) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'checklist-item';
                        itemElement.dataset.itemId = item.id || index;
                        itemElement.innerHTML = `
                            <div class="checkbox ${item.completed ? 'checked' : ''}"></div>
                            <div class="item-text ${item.completed ? 'completed' : ''}">
                                ${item.text}
                                ${item.createdBy ? `<span class="item-by">${item.createdBy}</span>` : ''}
                            </div>
                            <button class="delete-item-btn" title="Hapus item">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        // Toggle completed
                        const checkbox = itemElement.querySelector('.checkbox');
                        const itemText = itemElement.querySelector('.item-text');
                        
                        const toggleCompleted = async () => {
                            const newItems = [...items];
                            const itemIndex = newItems.findIndex(it => (it.id || newItems.indexOf(it)) === (item.id || index));
                            
                            if (itemIndex !== -1) {
                                newItems[itemIndex].completed = !newItems[itemIndex].completed;
                                newItems[itemIndex].updatedAt = new Date().toISOString();
                                
                                try {
                                    await db.collection('lists').doc(listId).update({
                                        items: newItems,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    // UI akan update otomatis via real-time listener
                                } catch (error) {
                                    console.error("Error updating item:", error);
                                    showToast('Gagal update item. Coba lagi.');
                                }
                            }
                        };
                        
                        checkbox.addEventListener('click', toggleCompleted);
                        itemText.addEventListener('click', function(e) {
                            if (!e.target.classList.contains('delete-item-btn') && !e.target.closest('.delete-item-btn')) {
                                toggleCompleted();
                            }
                        });
                        
                        // Hapus item
                        const deleteBtn = itemElement.querySelector('.delete-item-btn');
                        deleteBtn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            if (confirm('Yakin hapus item ini?')) {
                                const newItems = items.filter((it, idx) => (it.id || idx) !== (item.id || index));
                                
                                try {
                                    await db.collection('lists').doc(listId).update({
                                        items: newItems,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    showToast('Okeiii Itemnya udah dihapus!');
                                } catch (error) {
                                    console.error("Error deleting item:", error);
                                    showToast('Gagal menghapus item.');
                                }
                            }
                        });
                        
                        itemsContainer.appendChild(itemElement);
                    });
                }
            }

            // Tambah item baru
            async function addNewItem() {
                const itemText = newItemInput.value.trim();
                if (!itemText) {
                    showToast('Nama itemnya ngga boleh kosong yaa sayangg...');
                    newItemInput.focus();
                    return;
                }
                
                try {
                    addItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    addItemBtn.disabled = true;
                    
                    // Get current list
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) {
                        showToast('List tidak ditemukan!');
                        return;
                    }
                    
                    const list = listDoc.data();
                    const currentItems = list.items || [];
                    
                    // Add new item
                    const newItem = {
                        id: Date.now().toString(),
                        text: itemText,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        createdBy: getCurrentUserInitial()
                    };
                    
                    await listRef.update({
                        items: [...currentItems, newItem],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    newItemInput.value = '';
                    showToast('Kerenn!! Item berhasil ditambahin nihh! ðŸ’–');
                    newItemInput.focus();
                    
                } catch (error) {
                    console.error("Error adding item:", error);
                    showToast('Gagal menambah item. Coba lagi.');
                } finally {
                    addItemBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah Item';
                    addItemBtn.disabled = false;
                }
            }

            // Hapus list
            deleteListBtn.addEventListener('click', async function() {
                if (confirm('Yahhh Kamu yakin nih mau hapus list ini? nanti semua item di dalamnya bakal kehapus juga lohh...ðŸ™')) {
                    try {
                        await db.collection('lists').doc(listId).delete();
                        showToast('List berhasil dihapus!');
                        localStorage.removeItem('currentListId');
                        setTimeout(() => {
                            window.location.href = 'home.html';
                        }, 1000);
                    } catch (error) {
                        console.error("Error deleting list:", error);
                        showToast('Gagal menghapus list.');
                    }
                }
            });

            // Format tanggal
            function formatDate(timestamp, showTime = false) {
                if (!timestamp) return '-';
                
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                
                if (showTime) {
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 1) return 'Baru saja';
                    if (diffMins < 60) return `${diffMins} menit lalu`;
                    if (diffMins < 120) return '1 jam lalu';
                    
                    return date.toLocaleTimeString('id-ID', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                return date.toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            }

            // Get user initial
            function getCurrentUserInitial() {
                const hour = new Date().getHours();
                const deviceId = localStorage.getItem('deviceId') || 'dev_xxx';
                return hour < 12 ? `ðŸ’™ (${deviceId.substring(0, 3)})` : `ðŸ’— (${deviceId.substring(0, 3)})`;
            }

            // Update last active
            async function updateLastActive() {
                try {
                    await db.collection('sharedUsers').doc('couple_together').update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    // Ignore
                }
            }

            // Event Listeners
            addItemBtn.addEventListener('click', addNewItem);
            newItemInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewItem();
            });

            // Toast function
            function showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Cleanup
            window.addEventListener('beforeunload', function() {
                if (listUnsubscribe) {
                    listUnsubscribe();
                }
            });

            // Auto-focus
            newItemInput.focus();
            
            // Load list data
            loadList();
        });
    </script>
</body>
</html>
