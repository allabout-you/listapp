<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail List | with you</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’‘</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="list-page">
    <div class="container">
        <header class="list-header">
            <a href="home.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Kembali
            </a>
            <div class="list-title-container">
                <h1 id="list-title">Loading...</h1>
                <div class="list-stats">
                    <span class="stat-badge"><i class="fas fa-tasks"></i> <span id="total-items">0</span> item</span>
                    <span class="stat-badge"><i class="fas fa-check-circle"></i> <span id="completed-items">0</span> selesai</span>
                </div>
            </div>
            <button id="delete-list-btn" class="btn-delete" title="Hapus list">
                <i class="fas fa-trash-alt"></i>
            </button>
        </header>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Tambah Item Baru</h2>
                </div>
                
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-item-input" placeholder="Contoh: Nonton filmðŸŽ¬">
                        <button id="add-item-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Tambah Item
                        </button>
                    </div>
                </div>
            </div>

            <div class="card items-card">
                <div class="card-header">
                    <h2><i class="fas fa-check-square"></i> Checklist Items</h2>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <span class="progress-text" id="progress-percent">0%</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="items" class="items-list"></div>
                    
                    <div id="items-empty-state" class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Yahh list nya masih kosong nihh!</h3>
                        <p>Ayoo tambahin item listnya diatas buat bikin</p>
                    </div>
                    
                    <div class="live-update">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Live update aktif - perubahan langsung tersimpan</span>
                    </div>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Dibuat</h3>
                        <p id="created-date">-</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Progress</h3>
                        <p id="completion-rate">0%</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Terakhir Update</h3>
                        <p id="updated-date">Baru saja</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0i9FPn0-IHgG7kAnvTX6YIN356Q5ZUrM",
            authDomain: "with-you-app-8058a.firebaseapp.com",
            projectId: "with-you-app-8058a",
            storageBucket: "with-you-app-8058a.firebasestorage.app",
            messagingSenderId: "501566707158",
            appId: "1:501566707158:web:24f31d920555282bd5c077"
        };

        // Initialize Firebase
        let db;
        
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("âœ… Firebase initialized");
        } catch (error) {
            console.error("âŒ Firebase error:", error);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Cek login
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'index.html';
                return;
            }

            // Ambil list ID dan tampilkan debug info
            const listId = localStorage.getItem('currentListId');
            console.log("ðŸ” List ID dari localStorage:", listId);
            
            if (!listId) {
                console.error("âŒ List ID tidak ditemukan di localStorage");
                showToast('List tidak ditemukan! Kembali ke home...');
                setTimeout(() => window.location.href = 'home.html', 2000);
                return;
            }

            // DOM Elements
            const listTitle = document.getElementById('list-title');
            const totalItemsEl = document.getElementById('total-items');
            const completedItemsEl = document.getElementById('completed-items');
            const progressPercentEl = document.getElementById('progress-percent');
            const progressFill = document.getElementById('progress-fill');
            const createdDateEl = document.getElementById('created-date');
            const updatedDateEl = document.getElementById('updated-date');
            const completionRateEl = document.getElementById('completion-rate');
            const newItemInput = document.getElementById('new-item-input');
            const addItemBtn = document.getElementById('add-item-btn');
            const deleteListBtn = document.getElementById('delete-list-btn');
            const itemsContainer = document.getElementById('items');
            const itemsEmptyState = document.getElementById('items-empty-state');
            const liveUpdateEl = document.querySelector('.live-update');

            // Load list data dengan real-time listener
            function loadList() {
                if (!db) {
                    console.error("Database not initialized");
                    showToast('Database tidak terhubung');
                    return;
                }
                
                console.log("ðŸ”„ Loading list with ID:", listId);
                
                const listRef = db.collection('lists').doc(listId);
                
                // Gunakan onSnapshot untuk real-time updates
                listRef.onSnapshot((doc) => {
                    if (!doc.exists) {
                        console.error("List not found in Firestore");
                        showToast('List tidak ditemukan di database!');
                        setTimeout(() => window.location.href = 'home.html', 1500);
                        return;
                    }
                    
                    const list = doc.data();
                    console.log("âœ… List data loaded:", list.name);
                    updateListUI(list);
                    updateConnectionStatus(true);
                    
                }, (error) => {
                    console.error("Error in real-time listener:", error);
                    updateConnectionStatus(false);
                    showToast(`Error: ${error.message}`);
                });
            }

            // Update UI dengan data list
            function updateListUI(list) {
                // Set judul
                listTitle.textContent = list.name || 'Untitled List';
                
                // Hitung stats
                const items = list.items || [];
                const totalItems = items.length;
                const completedItems = items.filter(item => item.completed).length;
                const progressPercent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                
                // Update stats
                totalItemsEl.textContent = totalItems;
                completedItemsEl.textContent = completedItems;
                progressPercentEl.textContent = `${progressPercent}%`;
                progressFill.style.width = `${progressPercent}%`;
                completionRateEl.textContent = `${progressPercent}% Selesai`;
                
                // Update dates
                createdDateEl.textContent = formatDate(list.createdAt);
                updatedDateEl.textContent = formatDate(list.updatedAt, true);
                
                // Render items
                renderItems(items);
            }

            // Render items
            function renderItems(items) {
                if (items.length === 0) {
                    itemsEmptyState.style.display = 'block';
                    itemsContainer.style.display = 'none';
                    itemsContainer.innerHTML = '';
                    return;
                }
                
                itemsEmptyState.style.display = 'none';
                itemsContainer.style.display = 'flex';
                itemsContainer.innerHTML = '';
                
                items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'checklist-item';
                    itemElement.dataset.index = index;
                    itemElement.innerHTML = `
                        <div class="checkbox ${item.completed ? 'checked' : ''}"></div>
                        <div class="item-text ${item.completed ? 'completed' : ''}">
                            ${item.text || ''}
                        </div>
                        <button class="delete-item-btn" title="Hapus item">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Toggle completed
                    const checkbox = itemElement.querySelector('.checkbox');
                    const itemText = itemElement.querySelector('.item-text');
                    
                    const toggleHandler = () => toggleItemCompleted(index);
                    checkbox.addEventListener('click', toggleHandler);
                    itemText.addEventListener('click', function(e) {
                        if (!e.target.classList.contains('delete-item-btn')) {
                            toggleHandler();
                        }
                    });
                    
                    // Delete button
                    const deleteBtn = itemElement.querySelector('.delete-item-btn');
                    deleteBtn.addEventListener('click', async function(e) {
                        e.stopPropagation();
                        await deleteItem(index);
                    });
                    
                    itemsContainer.appendChild(itemElement);
                });
            }

            // Update connection status
            function updateConnectionStatus(connected) {
                if (liveUpdateEl) {
                    if (connected) {
                        liveUpdateEl.innerHTML = '<i class="fas fa-broadcast-tower"></i> <span>Live update aktif</span>';
                        liveUpdateEl.style.color = '#4CAF50';
                    } else {
                        liveUpdateEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Tidak terhubung</span>';
                        liveUpdateEl.style.color = '#FF9800';
                    }
                }
            }

            // ========== TAMBAH ITEM BARU (VERSI FIX) ==========
            async function addNewItem() {
                const itemText = newItemInput.value.trim();
                
                if (!itemText) {
                    showToast('Nama item tidak boleh kosong yaa sayangg...');
                    newItemInput.focus();
                    return;
                }
                
                if (!db) {
                    showToast('Database tidak terhubung');
                    return;
                }
                
                console.log("âž• Adding new item:", itemText);
                
                // Save button state
                const originalText = addItemBtn.innerHTML;
                const originalDisabled = addItemBtn.disabled;
                
                try {
                    // Disable button
                    addItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    addItemBtn.disabled = true;
                    
                    const listRef = db.collection('lists').doc(listId);
                    
                    // 1. Get current document
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) {
                        showToast('List tidak ditemukan!');
                        return;
                    }
                    
                    const listData = listDoc.data();
                    
                    // 2. Ensure items array exists
                    const currentItems = Array.isArray(listData.items) ? listData.items : [];
                    console.log("ðŸ“¦ Current items:", currentItems);
                    
                    // 3. Create new item (simple version)
                    const newItem = {
                        text: itemText,
                        completed: false,
                        createdAt: new Date().toISOString()
                    };
                    
                    // 4. Create updated array
                    const updatedItems = [...currentItems, newItem];
                    
                    // 5. Update using set with merge (LEBIH AMAN)
                    await listRef.set({
                        items: updatedItems,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log("âœ… Item berhasil disimpan!");
                    
                    // 6. Clear input
                    newItemInput.value = '';
                    showToast('Yeayy! Item berhasil ditambahkan! ðŸŽ‰');
                    newItemInput.focus();
                    
                    // Real-time listener akan otomatis update UI
                    
                } catch (error) {
                    console.error("âŒ ERROR adding item:", {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    if (error.code === 'permission-denied') {
                        showToast('Error: Izin ditolak. Cek Firebase Rules.');
                    } else if (error.code === 'not-found') {
                        showToast('Error: List tidak ditemukan.');
                    } else if (error.code === 'invalid-argument') {
                        showToast('Error: Format data tidak valid.');
                    } else {
                        showToast(`Error: ${error.message}`);
                    }
                    
                } finally {
                    // Always restore button
                    addItemBtn.innerHTML = originalText;
                    addItemBtn.disabled = originalDisabled;
                }
            }

            // Toggle item completed
            async function toggleItemCompleted(index) {
                try {
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) {
                        showToast('List tidak ditemukan!');
                        return;
                    }
                    
                    const listData = listDoc.data();
                    const items = listData.items || [];
                    
                    if (index >= items.length) {
                        console.error("Index out of bounds:", index);
                        return;
                    }
                    
                    // Toggle completion status
                    items[index].completed = !items[index].completed;
                    
                    // Update with set merge
                    await listRef.set({
                        items: items,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showToast(items[index].completed ? 'Yeayy! Item selesai! ðŸŽ‰' : 'Item belum selesai');
                    
                } catch (error) {
                    console.error("Error toggling item:", error);
                    showToast('Gagal update item');
                }
            }

            // Delete item
            async function deleteItem(index) {
                if (!confirm('Yakin hapus item ini?')) return;
                
                try {
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) {
                        showToast('List tidak ditemukan!');
                        return;
                    }
                    
                    const listData = listDoc.data();
                    const items = listData.items || [];
                    
                    if (index >= items.length) {
                        console.error("Index out of bounds:", index);
                        return;
                    }
                    
                    // Remove item at index
                    items.splice(index, 1);
                    
                    // Update with set merge
                    await listRef.set({
                        items: items,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showToast('Item berhasil dihapus!');
                    
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast('Gagal menghapus item');
                }
            }

            // Hapus seluruh list
            deleteListBtn.addEventListener('click', async function() {
                if (!confirm('Yakin hapus list ini? Semua item akan hilang.')) return;
                
                try {
                    await db.collection('lists').doc(listId).delete();
                    showToast('List berhasil dihapus!');
                    localStorage.removeItem('currentListId');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1000);
                } catch (error) {
                    console.error("Error deleting list:", error);
                    showToast('Gagal menghapus list');
                }
            });

            // Format tanggal
            function formatDate(timestamp, showTime = false) {
                if (!timestamp) return '-';
                
                try {
                    let date;
                    if (timestamp && timestamp.toDate) {
                        date = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        date = timestamp;
                    } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
                        date = new Date(timestamp);
                    } else {
                        return '-';
                    }
                    
                    if (isNaN(date.getTime())) return '-';
                    
                    if (showTime) {
                        const now = new Date();
                        const diffMs = now - date;
                        const diffMins = Math.floor(diffMs / 60000);
                        
                        if (diffMins < 1) return 'Baru saja';
                        if (diffMins < 60) return `${diffMins} menit lalu`;
                        if (diffMins < 120) return '1 jam lalu';
                        
                        return date.toLocaleTimeString('id-ID', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    });
                } catch (error) {
                    console.error("Date formatting error:", error);
                    return '-';
                }
            }

            // Toast function
            function showToast(message) {
                try {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                } catch (error) {
                    console.error("Toast error:", error);
                }
            }

            // Event listeners
            addItemBtn.addEventListener('click', addNewItem);
            newItemInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewItem();
            });

            // Auto-focus
            setTimeout(() => {
                newItemInput.focus();
            }, 500);
            
            // Load data
            loadList();
        });
    </script>
</body>
</html>
