<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail List | with you</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíë</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="list-page">
    <div class="container">
        <header class="list-header">
            <a href="home.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Kembali
            </a>
            <div class="list-title-container">
                <h1 id="list-title">Loading...</h1>
                <div class="list-stats">
                    <span class="stat-badge"><i class="fas fa-tasks"></i> <span id="total-items">0</span> item</span>
                    <span class="stat-badge"><i class="fas fa-check-circle"></i> <span id="completed-items">0</span> selesai</span>
                </div>
            </div>
            <button id="delete-list-btn" class="btn-delete" title="Hapus list">
                <i class="fas fa-trash-alt"></i>
            </button>
        </header>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Tambah Item Baru</h2>
                </div>
                
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-item-input" placeholder="Contoh: Nonton filmüé¨">
                        <button id="add-item-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Tambah Item
                        </button>
                    </div>
                </div>
            </div>

            <div class="card items-card">
                <div class="card-header">
                    <h2><i class="fas fa-check-square"></i> Checklist Items</h2>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <span class="progress-text" id="progress-percent">0%</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="items" class="items-list"></div>
                    
                    <div id="items-empty-state" class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Yahh list nya masih kosong nihh!</h3>
                        <p>Ayoo tambahin item listnya diatas buat bikin</p>
                    </div>
                    
                    <div class="live-update">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Live update aktif - perubahan langsung tersimpan</span>
                    </div>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Dibuat</h3>
                        <p id="created-date">-</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Progress</h3>
                        <p id="completion-rate">0%</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Terakhir Update</h3>
                        <p id="updated-date">Baru saja</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0i9FPn0-IHgG7kAnvTX6YIN356Q5ZUrM",
            authDomain: "with-you-app-8058a.firebaseapp.com",
            projectId: "with-you-app-8058a",
            storageBucket: "with-you-app-8058a.firebasestorage.app",
            messagingSenderId: "501566707158",
            appId: "1:501566707158:web:24f31d920555282bd5c077"
        };
    
        // Initialize Firebase
        let db;
        
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("‚úÖ Firebase initialized");
        } catch (error) {
            console.error("‚ùå Firebase error:", error);
        }
    
        document.addEventListener('DOMContentLoaded', function() {
            // Cek login
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'index.html';
                return;
            }
    
            // Ambil list ID
            const listId = localStorage.getItem('currentListId');
            if (!listId) {
                window.location.href = 'home.html';
                return;
            }
    
            console.log("List ID:", listId);
    
            // DOM Elements
            const listTitle = document.getElementById('list-title');
            const totalItemsEl = document.getElementById('total-items');
            const completedItemsEl = document.getElementById('completed-items');
            const progressPercentEl = document.getElementById('progress-percent');
            const progressFill = document.getElementById('progress-fill');
            const newItemInput = document.getElementById('new-item-input');
            const addItemBtn = document.getElementById('add-item-btn');
            const deleteListBtn = document.getElementById('delete-list-btn');
            const itemsContainer = document.getElementById('items');
            const itemsEmptyState = document.getElementById('items-empty-state');
    
            // Load list data dengan cara sederhana
            function loadList() {
                if (!db) {
                    console.error("Database not initialized");
                    showToast('Database tidak terhubung');
                    return;
                }
                
                console.log("Loading list with ID:", listId);
                
                const listRef = db.collection('lists').doc(listId);
                
                // Gunakan get() dulu untuk testing
                listRef.get().then((doc) => {
                    if (!doc.exists) {
                        console.error("List not found");
                        showToast('List tidak ditemukan!');
                        setTimeout(() => window.location.href = 'home.html', 1500);
                        return;
                    }
                    
                    const list = doc.data();
                    console.log("List data loaded:", list);
                    
                    updateListUI(list);
                    
                }).catch((error) => {
                    console.error("Error loading list:", error);
                    showToast(`Error: ${error.message}`);
                });
            }
    
            // Update UI
            function updateListUI(list) {
                listTitle.textContent = list.name || 'Untitled List';
                
                const items = list.items || [];
                const totalItems = items.length;
                const completedItems = items.filter(item => item.completed).length;
                const progressPercent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                
                totalItemsEl.textContent = totalItems;
                completedItemsEl.textContent = completedItems;
                progressPercentEl.textContent = `${progressPercent}%`;
                progressFill.style.width = `${progressPercent}%`;
                
                renderItems(items);
            }
    
            // Render items sederhana
            function renderItems(items) {
                if (items.length === 0) {
                    itemsEmptyState.style.display = 'block';
                    itemsContainer.style.display = 'none';
                    itemsContainer.innerHTML = '';
                    return;
                }
                
                itemsEmptyState.style.display = 'none';
                itemsContainer.style.display = 'flex';
                itemsContainer.innerHTML = '';
                
                items.forEach((item, index) => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'checklist-item';
                    itemElement.innerHTML = `
                        <div class="checkbox ${item.completed ? 'checked' : ''}"></div>
                        <div class="item-text ${item.completed ? 'completed' : ''}">
                            ${item.text || ''}
                        </div>
                        <button class="delete-item-btn" title="Hapus item">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    // Toggle completed
                    const checkbox = itemElement.querySelector('.checkbox');
                    const itemText = itemElement.querySelector('.item-text');
                    
                    checkbox.addEventListener('click', () => toggleItemCompleted(index));
                    itemText.addEventListener('click', () => toggleItemCompleted(index));
                    
                    // Delete button
                    const deleteBtn = itemElement.querySelector('.delete-item-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteItem(index);
                    });
                    
                    itemsContainer.appendChild(itemElement);
                });
            }
    
            // Toggle item completed
            async function toggleItemCompleted(index) {
                try {
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) return;
                    
                    const list = listDoc.data();
                    const items = list.items || [];
                    
                    if (index >= items.length) return;
                    
                    items[index].completed = !items[index].completed;
                    
                    await listRef.update({
                        items: items,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast(items[index].completed ? 'Yeayy item selesai! üéâ' : 'Item belum selesai');
                    
                } catch (error) {
                    console.error("Error toggling item:", error);
                    showToast('Gagal update item');
                }
            }
    
            // Delete item
            async function deleteItem(index) {
                if (!confirm('Yakin hapus item ini?')) return;
                
                try {
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) return;
                    
                    const list = listDoc.data();
                    const items = list.items || [];
                    
                    if (index >= items.length) return;
                    
                    items.splice(index, 1);
                    
                    await listRef.update({
                        items: items,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showToast('Item berhasil dihapus!');
                    
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast('Gagal menghapus item');
                }
            }
    
            // TAMBAH ITEM BARU - VERSI SEDERHANA
            async function addNewItem() {
                const itemText = newItemInput.value.trim();
                
                if (!itemText) {
                    showToast('Nama item tidak boleh kosong');
                    newItemInput.focus();
                    return;
                }
                
                if (!db) {
                    showToast('Database tidak terhubung');
                    return;
                }
                
                console.log("Adding new item:", itemText);
                
                // Simpan state tombol
                const originalText = addItemBtn.innerHTML;
                const originalDisabled = addItemBtn.disabled;
                
                try {
                    // Disable button
                    addItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    addItemBtn.disabled = true;
                    
                    // 1. Ambil list dulu
                    const listRef = db.collection('lists').doc(listId);
                    const listDoc = await listRef.get();
                    
                    if (!listDoc.exists) {
                        showToast('List tidak ditemukan!');
                        return;
                    }
                    
                    const list = listDoc.data();
                    const currentItems = list.items || [];
                    
                    console.log("Current items:", currentItems);
                    
                    // 2. Buat item baru
                    const newItem = {
                        text: itemText,
                        completed: false,
                        createdAt: new Date().toISOString()
                        // No id, no createdBy
                    };
                    
                    // 3. Update ke Firebase
                    await listRef.update({
                        items: [...currentItems, newItem],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log("Item added successfully!");
                    
                    // 4. Clear input
                    newItemInput.value = '';
                    showToast('Item berhasil ditambahkan! üíñ');
                    newItemInput.focus();
                    
                    // 5. Reload list untuk update UI
                    loadList();
                    
                } catch (error) {
                    console.error("‚ùå ERROR adding item:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    console.error("Error stack:", error.stack);
                    
                    // Tampilkan error detail
                    if (error.code === 'permission-denied') {
                        showToast('ERROR: Permission denied. Cek Firebase Rules!');
                    } else if (error.code === 'not-found') {
                        showToast('ERROR: Document not found');
                    } else {
                        showToast(`ERROR: ${error.message}`);
                    }
                    
                } finally {
                    // Restore button
                    addItemBtn.innerHTML = originalText;
                    addItemBtn.disabled = originalDisabled;
                }
            }
    
            // Hapus list
            deleteListBtn.addEventListener('click', async function() {
                if (!confirm('Yakin hapus list ini?')) return;
                
                try {
                    await db.collection('lists').doc(listId).delete();
                    showToast('List berhasil dihapus!');
                    localStorage.removeItem('currentListId');
                    setTimeout(() => {
                        window.location.href = 'home.html';
                    }, 1000);
                } catch (error) {
                    console.error("Error deleting list:", error);
                    showToast('Gagal menghapus list');
                }
            });
    
            // Toast function
            function showToast(message) {
                try {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                } catch (error) {
                    console.error("Toast error:", error);
                }
            }
    
            // Event listeners
            addItemBtn.addEventListener('click', addNewItem);
            newItemInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewItem();
            });
    
            // Auto-focus
            setTimeout(() => {
                newItemInput.focus();
            }, 500);
            
            // Load data
            loadList();
            
            // Coba test koneksi Firebase
            console.log("Testing Firebase connection...");
            if (db) {
                db.collection('test').doc('test').get()
                    .then(() => console.log("‚úÖ Firebase connection OK"))
                    .catch(err => console.log("‚ùå Firebase connection error:", err));
            }
        });
    </script>
</body>
</html>
