<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | withyou</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíë</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="home-page">
    <div class="container">
        <header class="main-header">
            <div class="header-left">
                <p class="welcome-text">haii sayanggkuuuüòç</p>
                <div class="sync-indicator" id="sync-indicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>Memuat...</span>
                </div>
            </div>
            <div class="header-right">
                <button id="logout-btn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Buat List Baru</h2>
                    <p class="card-subtitle">Mulai petualangan baru kita</p>
                </div>
                
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-list-input" placeholder="Contoh: List Jalan-Jalanüòã">
                        <button id="add-list-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Tambah List
                        </button>
                    </div>
                    <p class="hint-text">List akan langsung terlihat oleh kita berdua üíï</p>
                </div>
            </div>

            <div class="card lists-card">
                <div class="card-header">
                    <h2><i class="fas fa-list-alt"></i> Daftar List Kita</h2>
                    <div class="filter-section">
                        <span class="filter-label">Filter:</span>
                        <button class="filter-btn active" data-filter="all">Semua</button>
                        <button class="filter-btn" data-filter="active">Aktif</button>
                        <button class="filter-btn" data-filter="completed">Selesai</button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="lists" class="lists-grid"></div>
                    
                    <div id="empty-state" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-heart"></i>
                            <i class="fas fa-plus"></i>
                        </div>
                        <h3>Belum ada list nih!</h3>
                        <p>Ayo bikin list pertama kita di atas, Gampang kok sayangg</p>
                        <p class="empty-hint">Coba buat list kayak<br>"List Main 14 Februari" atau "List lainnya"</p>
                    </div>
                    
                    <div id="loading-state" class="loading-state" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Memuat list...</span>
                    </div>
                </div>
            </div>
            
            <div class="shared-notice">
                <i class="fas fa-users"></i>
                <p><strong>Live Sync Aktif</strong> - Perubahan yang kamu buat akan langsung terlihat oleh pasanganmu!</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC0i9FPn0-IHgG7kAnvTX6YIN356Q5ZUrM",
            authDomain: "with-you-app-8058a.firebaseapp.com",
            projectId: "with-you-app-8058a",
            storageBucket: "with-you-app-8058a.firebasestorage.app",
            messagingSenderId: "501566707158",
            appId: "1:501566707158:web:24f31d920555282bd5c077"
        };
    
        // Initialize Firebase dengan error handling
        let firebaseApp;
        let db;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
        }
    
        // Shared user ID
        const SHARED_USER_ID = "couple_together";
    
        document.addEventListener('DOMContentLoaded', function() {
            // Cek login
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'index.html';
                return;
            }
    
            // DOM Elements
            const logoutBtn = document.getElementById('logout-btn');
            const addListBtn = document.getElementById('add-list-btn');
            const newListInput = document.getElementById('new-list-input');
            const listsContainer = document.getElementById('lists');
            const emptyState = document.getElementById('empty-state');
            const syncIndicator = document.getElementById('sync-indicator');
    
            // Cek Firebase connection
            if (!db) {
                console.error("‚ùå Firestore not initialized");
                syncIndicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>Firebase Error</span>`;
                syncIndicator.style.color = "#FF5252";
                showToast('Firebase tidak terhubung. Coba refresh.');
                return;
            }
    
            // List icons
            const listIcons = ["üíë", "‚ù§Ô∏è", "üéØ", "‚ú®", "üåü", "üé®", "üå∏", "üíé", "üéÅ", "üçø", "üé¨", "‚úàÔ∏è", "üå¥", "üçΩÔ∏è", "üéµ"];
            
            // Real-time listener untuk lists
            let listsUnsubscribe = null;
    
            // DEBUG: Test Firebase connection
            testFirebaseConnection();
    
            // Fungsi test connection
            async function testFirebaseConnection() {
                try {
                    console.log("üîç Testing Firebase connection...");
                    syncIndicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Testing connection...</span>`;
                    
                    // Test dengan query sederhana
                    const testQuery = await db.collection('lists').limit(1).get();
                    console.log("‚úÖ Firebase connection test successful");
                    console.log("üìä Test query result:", testQuery.empty ? "No documents" : "Has documents");
                    
                    // Jika sukses, load lists
                    loadLists();
                    
                } catch (error) {
                    console.error("‚ùå Firebase connection test failed:", error);
                    console.error("Error details:", error.code, error.message);
                    syncIndicator.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>Connection Failed</span>`;
                    syncIndicator.style.color = "#FF5252";
                    showToast(`Firebase error: ${error.code || error.message}`);
                    
                    // Coba lagi setelah 3 detik
                    setTimeout(testFirebaseConnection, 3000);
                }
            }
    
            // Fungsi untuk load lists dari Firebase
            function loadLists() {
                console.log("üì• Loading lists from Firestore...");
                
                // Unsubscribe sebelumnya jika ada
                if (listsUnsubscribe) {
                    console.log("üîÑ Unsubscribing previous listener");
                    listsUnsubscribe();
                }
    
                syncIndicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>Loading...</span>`;
    
                try {
                    // Subscribe ke real-time updates
                    listsUnsubscribe = db.collection('lists')
                        .where('sharedUserId', '==', SHARED_USER_ID)
                        .orderBy('createdAt', 'desc')
                        .onSnapshot(
                            // Success callback
                            (snapshot) => {
                                console.log("‚úÖ Lists snapshot received:", snapshot.size, "documents");
                                
                                listsContainer.innerHTML = '';
                                let hasLists = false;
                                let listsCount = 0;
                                
                                snapshot.forEach((doc) => {
                                    console.log("üìÑ Document:", doc.id, doc.data());
                                    hasLists = true;
                                    listsCount++;
                                    const list = {
                                        id: doc.id,
                                        ...doc.data()
                                    };
                                    
                                    renderList(list);
                                });
                                
                                emptyState.style.display = hasLists ? 'none' : 'block';
                                syncIndicator.innerHTML = `<i class="fas fa-check-circle"></i> <span>${listsCount} list ‚Ä¢ Live</span>`;
                                syncIndicator.style.color = "#4CAF50";
                                
                                if (!hasLists) {
                                    console.log("‚ÑπÔ∏è No lists found for sharedUserId:", SHARED_USER_ID);
                                }
                                
                                // Update last active time
                                updateLastActive();
                            },
                            // Error callback
                            (error) => {
                                console.error("‚ùå Error in lists listener:", error);
                                console.error("Error code:", error.code);
                                console.error("Error message:", error.message);
                                
                                syncIndicator.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>Sync Error</span>`;
                                syncIndicator.style.color = "#FF5252";
                                
                                let errorMessage = 'Gagal sinkron data. ';
                                if (error.code === 'permission-denied') {
                                    errorMessage += 'Permission denied. Cek Firestore Rules.';
                                } else if (error.code === 'failed-precondition') {
                                    errorMessage += 'Perlu index. Cek console Firebase.';
                                } else {
                                    errorMessage += error.message;
                                }
                                
                                showToast(errorMessage);
                                
                                // Coba lagi setelah 5 detik
                                setTimeout(loadLists, 5000);
                            }
                        );
                        
                    console.log("üëÇ List listener attached");
                    
                } catch (error) {
                    console.error("‚ùå Error setting up listener:", error);
                    syncIndicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>Setup Error</span>`;
                    syncIndicator.style.color = "#FF9800";
                    showToast('Error setup listener: ' + error.message);
                }
            }
    
            // Fungsi untuk render satu list
            function renderList(list) {
                console.log("üé® Rendering list:", list.name);
                
                const completedCount = list.items ? list.items.filter(item => item.completed).length : 0;
                const totalCount = list.items ? list.items.length : 0;
                const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                
                const listElement = document.createElement('div');
                listElement.className = 'list-item';
                listElement.innerHTML = `
                    <div class="list-icon">${list.icon || 'üíë'}</div>
                    <div class="list-content">
                        <h3>${list.name}</h3>
                        <div class="list-meta">
                            <span><i class="far fa-calendar"></i> ${formatDate(list.createdAt)}</span>
                            ${list.createdBy ? `<span><i class="fas fa-user"></i> ${list.createdBy}</span>` : ''}
                        </div>
                        <div class="list-stats">
                            <span><i class="fas fa-check-circle"></i> ${completedCount}/${totalCount}</span>
                            <span><i class="fas fa-chart-line"></i> ${progress}%</span>
                            <span><i class="far fa-clock"></i> ${totalCount} items</span>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right arrow-icon"></i>
                `;
                
                listElement.addEventListener('click', function() {
                    localStorage.setItem('currentListId', list.id);
                    window.location.href = 'list.html';
                });
                
                listsContainer.appendChild(listElement);
            }
    
            // Fungsi untuk tambah list baru
            async function addNewList() {
                const listName = newListInput.value.trim();
                if (!listName) {
                    showToast('Nama listnya ngga boleh kosong yaa sayanggg');
                    newListInput.focus();
                    return;
                }
                
                console.log("‚ûï Adding new list:", listName);
                
                try {
                    // Disable button saat proses
                    const originalText = addListBtn.innerHTML;
                    const originalDisabled = addListBtn.disabled;
                    addListBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    addListBtn.disabled = true;
                    
                    // Data untuk list baru
                    const listData = {
                        name: listName,
                        sharedUserId: SHARED_USER_ID,
                        icon: listIcons[Math.floor(Math.random() * listIcons.length)],
                        items: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: getCurrentUserInitial()
                    };
                    
                    console.log("üìù List data to save:", listData);
                    
                    // Simpan ke Firebase
                    const docRef = await db.collection('lists').add(listData);
                    console.log("‚úÖ List saved with ID:", docRef.id);
                    
                    // Reset input
                    newListInput.value = '';
                    showToast(`Yeayyy kerenn! List "${listName}" berhasil dibuat! ü•π`);
                    newListInput.focus();
                    
                } catch (error) {
                    console.error("‚ùå Error adding list:", error);
                    console.error("Error details:", error.code, error.message);
                    
                    let errorMsg = 'Gagal membuat list. ';
                    if (error.code === 'permission-denied') {
                        errorMsg += 'Permission denied. Cek Firestore Rules.';
                    } else {
                        errorMsg += error.message;
                    }
                    
                    showToast(errorMsg);
                    
                    // Restore button
                    addListBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah List';
                    addListBtn.disabled = false;
                }
            }
    
            // Fungsi untuk update last active time
            async function updateLastActive() {
                if (!db) return;
                
                try {
                    await db.collection('sharedUsers').doc(SHARED_USER_ID).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error updating lastActive:", error);
                }
            }
    
            // Fungsi untuk mendapatkan inisial user
            function getCurrentUserInitial() {
                try {
                    const hour = new Date().getHours();
                    let deviceId = localStorage.getItem('deviceId');
                    
                    if (!deviceId) {
                        deviceId = 'dev_' + Math.random().toString(36).substr(2, 6);
                        localStorage.setItem('deviceId', deviceId);
                    }
                    
                    return hour < 12 ? `üíô (${deviceId.substring(0, 3)})` : `üíó (${deviceId.substring(0, 3)})`;
                } catch (error) {
                    return 'üíë';
                }
            }
    
            // Format tanggal
            function formatDate(timestamp) {
                if (!timestamp) return 'Baru saja';
                
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    if (isNaN(date.getTime())) return '-';
                    
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'Baru saja';
                    if (diffMins < 60) return `${diffMins} menit lalu`;
                    if (diffHours < 24) return `${diffHours} jam lalu`;
                    if (diffDays < 7) return `${diffDays} hari lalu`;
                    
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'short'
                    });
                } catch (error) {
                    return '-';
                }
            }
    
            // Logout
            logoutBtn.addEventListener('click', function() {
                if (confirm('Yakin kamu mau keluar dari website ini sayanggg?')) {
                    if (listsUnsubscribe) {
                        listsUnsubscribe();
                    }
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentListId');
                    showToast('Sampai jumpa lagii sayangg, babayyyy!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            });
    
            // Event Listeners
            addListBtn.addEventListener('click', addNewList);
            newListInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewList();
            });
    
            // Toast function
            function showToast(message) {
                try {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                } catch (error) {
                    console.error("Toast error:", error);
                }
            }
    
            // Cleanup
            window.addEventListener('beforeunload', function() {
                if (listsUnsubscribe) {
                    console.log("üßπ Cleaning up listener");
                    listsUnsubscribe();
                }
            });
    
            // Auto-focus pada input
            setTimeout(() => {
                newListInput.focus();
            }, 1000);
        });
    </script>
