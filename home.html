<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home | withyou</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíë</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="home-page">
    <div class="container">
        <!-- User Selection Modal -->
        <div id="user-modal" class="user-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-heart"></i> Hai, Kamu yang mana?</h2>
                    <p class="modal-subtitle">Pilih identitas kamu biar kita tau siapa nih yang bikin list</p>
                </div>
                <div class="user-options">
                    <div class="user-option boy-option" data-user="boy">
                        <div class="user-emoji">üíô</div>
                        <h3>Boy</h3>
                        <p>(Biasanya cowo)</p>
                        <div class="user-desc">
                            <p><i class="fas fa-check-circle"></i> Akan muncul sebagai üíô</p>
                            <p><i class="fas fa-user"></i> Bisa buat & edit list</p>
                        </div>
                    </div>
                    <div class="user-option girl-option" data-user="girl">
                        <div class="user-emoji">üíó</div>
                        <h3>Girl</h3>
                        <p>(Biasanya cewe)</p>
                        <div class="user-desc">
                            <p><i class="fas fa-check-circle"></i> Akan muncul sebagai üíó</p>
                            <p><i class="fas fa-user"></i> Bisa buat & edit list</p>
                        </div>
                    </div>
                </div>
                <div class="modal-note">
                    <p><i class="fas fa-info-circle"></i> Pilihan akan disimpan di perangkat ini</p>
                    <p><i class="fas fa-sync-alt"></i> Bisa ganti nanti di menu settings</p>
                </div>
            </div>
        </div>

        <header class="main-header">
            <div class="header-left">
                <p class="welcome-text" id="welcome-text">haii sayanggkuuuüòç</p>
                <div class="sync-indicator" id="sync-indicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>Memuat...</span>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info" id="user-info" style="display: none;">
                    <div class="user-badge" id="user-badge">
                        <i class="fas fa-user"></i>
                        <span id="user-name">Loading...</span>
                    </div>
                    <button id="change-user-btn" class="btn-change-user" title="Ganti user">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <button id="logout-btn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Buat List Baru</h2>
                    <p class="card-subtitle">Mulai petualangan baru kita</p>
                </div>
                
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-list-input" placeholder="Contoh: List Jalan-Jalanüòã">
                        <button id="add-list-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Tambah List
                        </button>
                    </div>
                    <p class="hint-text">List akan langsung terlihat oleh kita berdua üíï</p>
                </div>
            </div>

            <div class="card lists-card">
                <div class="card-header">
                    <h2><i class="fas fa-list-alt"></i> Daftar List Kita</h2>
                    <div class="filter-section">
                        <span class="filter-label">Filter:</span>
                        <button class="filter-btn active" data-filter="all">Semua</button>
                        <button class="filter-btn" data-filter="active">Aktif</button>
                        <button class="filter-btn" data-filter="completed">Selesai</button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="lists" class="lists-grid"></div>
                    
                    <div id="empty-state" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-heart"></i>
                            <i class="fas fa-plus"></i>
                        </div>
                        <h3>Belum ada list nih!</h3>
                        <p>Ayo bikin list pertama kita di atas, Gampang kok sayangg</p>
                        <p class="empty-hint">Coba buat list kayak<br>"List Main 14 Februari" atau "List lainnya"</p>
                    </div>
                    
                    <div id="loading-state" style="text-align: center; padding: 20px; color: var(--text-secondary); display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat data...
                    </div>
                </div>
            </div>
            
            <div class="debug-info" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #666; display: none;">
                <strong>Debug Info:</strong> <span id="debug-text">-</span>
            </div>
        </div>
    </div>

    <!-- Toast Notifikasi -->
    <div id="toast" class="toast"></div>

    <script>
        // ==================== FIREBASE SETUP ====================
        const firebaseConfig = {
            apiKey: "AIzaSyC0i9FPn0-IHgG7kAnvTX6YIN356Q5ZUrM",
            authDomain: "with-you-app-8058a.firebaseapp.com",
            projectId: "with-you-app-8058a",
            storageBucket: "with-you-app-8058a.firebasestorage.app",
            messagingSenderId: "501566707158",
            appId: "1:501566707158:web:24f31d920555282bd5c077"
        };

        // Initialize Firebase
        let app;
        let db;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("‚úÖ Firebase initialized");
        } catch (error) {
            console.error("‚ùå Firebase error:", error);
        }

        const SHARED_USER_ID = "couple_together";

        // ==================== USER MANAGEMENT ====================
        class UserManager {
            constructor() {
                this.currentUser = null;
                this.deviceId = this.getDeviceId();
                this.init();
            }

            getDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'dev_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            }

            init() {
                // Load user dari localStorage
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                }
            }

            getUser() {
                return this.currentUser;
            }

            getUserForDisplay() {
                if (!this.currentUser) return "üíë Guest";
                
                const emoji = this.currentUser.type === 'boy' ? 'üíô' : 'üíó';
                const name = this.currentUser.type === 'boy' ? 'Boy' : 'Girl';
                const shortId = this.deviceId.substring(0, 4);
                
                return `${emoji} ${name} (${shortId})`;
            }

            getUserForDatabase() {
                if (!this.currentUser) {
                    return {
                        type: 'guest',
                        emoji: 'üíë',
                        name: 'Guest',
                        deviceId: this.deviceId
                    };
                }
                
                return {
                    type: this.currentUser.type,
                    emoji: this.currentUser.type === 'boy' ? 'üíô' : 'üíó',
                    name: this.currentUser.type === 'boy' ? 'Boy' : 'Girl',
                    deviceId: this.deviceId,
                    selectedAt: this.currentUser.selectedAt
                };
            }

            setUser(userType) {
                this.currentUser = {
                    type: userType,
                    selectedAt: new Date().toISOString()
                };
                
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                
                // Simpan ke Firebase juga untuk tracking
                this.saveUserToFirebase();
                
                // Update UI
                this.updateUI();
                
                return this.currentUser;
            }

            async saveUserToFirebase() {
                if (!db) return;
                
                try {
                    const userData = this.getUserForDatabase();
                    userData.lastSeen = firebase.firestore.FieldValue.serverTimestamp();
                    
                    await db.collection('users').doc(this.deviceId).set(userData, { merge: true });
                    console.log("‚úÖ User saved to Firebase");
                } catch (error) {
                    console.error("‚ùå Error saving user to Firebase:", error);
                }
            }

            updateUI() {
                const welcomeText = document.getElementById('welcome-text');
                const userBadge = document.getElementById('user-badge');
                const userNameSpan = document.getElementById('user-name');
                const userInfoDiv = document.getElementById('user-info');
                
                if (this.currentUser) {
                    const displayText = this.getUserForDisplay();
                    
                    // Update welcome text berdasarkan user
                    if (this.currentUser.type === 'boy') {
                        welcomeText.textContent = "Hai my lovely girl! üòò";
                    } else if (this.currentUser.type === 'girl') {
                        welcomeText.textContent = "Hai sayanggkuuu! üòç";
                    } else {
                        welcomeText.textContent = "Hai kita berdua! üíï";
                    }
                    
                    // Update user badge
                    userNameSpan.textContent = displayText;
                    userInfoDiv.style.display = 'flex';
                    
                    // Update badge color
                    userBadge.className = `user-badge ${this.currentUser.type}`;
                } else {
                    userInfoDiv.style.display = 'none';
                    welcomeText.textContent = "haii sayanggkuuuüòç";
                }
            }

            showSelectionModal() {
                const modal = document.getElementById('user-modal');
                modal.style.display = 'flex';
                
                // Tambahkan event listeners untuk pilihan
                const options = document.querySelectorAll('.user-option');
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const userType = option.dataset.user;
                        this.setUser(userType);
                        modal.style.display = 'none';
                        showToast(`Yeayy! Sekarang kamu jadi ${userType === 'boy' ? 'üíô Boy' : 'üíó Girl'}!`);
                    });
                });
            }

            changeUser() {
                if (confirm('Yakin mau ganti user? Pilihanmu akan disimpan.')) {
                    this.showSelectionModal();
                }
            }
        }

        // ==================== APP LOGIC ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize User Manager
            const userManager = new UserManager();
            
            // Debug elements
            const debugInfo = document.querySelector('.debug-info');
            const debugText = document.getElementById('debug-text');
            
            // Show debug info
            debugInfo.style.display = 'block';
            debugText.textContent = 'App loaded, checking login...';

            // Cek login
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                debugText.textContent = 'Not logged in, redirecting...';
                window.location.href = 'index.html';
                return;
            }

            debugText.textContent = 'Logged in, initializing...';

            // DOM Elements
            const logoutBtn = document.getElementById('logout-btn');
            const addListBtn = document.getElementById('add-list-btn');
            const newListInput = document.getElementById('new-list-input');
            const listsContainer = document.getElementById('lists');
            const emptyState = document.getElementById('empty-state');
            const syncIndicator = document.getElementById('sync-indicator');
            const loadingState = document.getElementById('loading-state');
            const changeUserBtn = document.getElementById('change-user-btn');

            // List icons
            const listIcons = ["üíë", "‚ù§Ô∏è", "üéØ", "‚ú®", "üåü", "üé®", "üå∏", "üíé", "üéÅ", "üçø", "üé¨", "‚úàÔ∏è", "üå¥", "üçΩÔ∏è", "üéµ"];
            
            // Store loaded lists
            let loadedLists = [];

            // ==================== CHECK USER SELECTION ====================
            function checkUserSelection() {
                if (!userManager.getUser()) {
                    // Tampilkan modal pilihan user
                    setTimeout(() => {
                        userManager.showSelectionModal();
                    }, 500);
                } else {
                    // Update UI dengan user yang sudah dipilih
                    userManager.updateUI();
                }
            }

            // ==================== LOAD LISTS ====================
            async function loadListsSimple() {
                debugText.textContent = 'Loading lists...';
                loadingState.style.display = 'block';
                listsContainer.innerHTML = '';
                emptyState.style.display = 'none';
                syncIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Loading...</span>';

                try {
                    // Get all lists for our shared user
                    const querySnapshot = await db.collection('lists')
                        .where('sharedUserId', '==', SHARED_USER_ID)
                        .orderBy('updatedAt', 'desc')
                        .get();
                    
                    debugText.textContent = `Found ${querySnapshot.size} lists`;
                    
                    if (querySnapshot.empty) {
                        emptyState.style.display = 'block';
                        syncIndicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>0 list ‚Ä¢ Ready</span>';
                        loadedLists = [];
                    } else {
                        loadedLists = [];
                        querySnapshot.forEach((doc) => {
                            loadedLists.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        renderAllLists();
                        syncIndicator.innerHTML = `<i class="fas fa-check-circle"></i> <span>${loadedLists.length} list ‚Ä¢ Ready</span>`;
                    }
                    
                } catch (error) {
                    console.error("Error loading lists:", error);
                    debugText.textContent = `Load error: ${error.code}`;
                    syncIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span>Load Error</span>';
                    syncIndicator.style.color = "#FF5252";
                    
                    if (error.code === 'failed-precondition') {
                        showToast('Perlu buat index di Firebase Console. Klik link error untuk buat otomatis.');
                    } else {
                        showToast(`Error: ${error.message}`);
                    }
                    
                    // Fallback: Show empty state
                    emptyState.style.display = 'block';
                } finally {
                    loadingState.style.display = 'none';
                }
            }

            // ==================== RENDER LISTS ====================
            function renderAllLists() {
                listsContainer.innerHTML = '';
                
                if (loadedLists.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                loadedLists.forEach(list => {
                    const completedCount = list.items ? list.items.filter(item => item.completed).length : 0;
                    const totalCount = list.items ? list.items.length : 0;
                    const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    
                    // Determine creator badge style
                    let creatorBadgeClass = 'creator-badge';
                    if (list.createdBy && list.createdBy.includes('üíô')) {
                        creatorBadgeClass += ' creator-boy';
                    } else if (list.createdBy && list.createdBy.includes('üíó')) {
                        creatorBadgeClass += ' creator-girl';
                    }
                    
                    const listElement = document.createElement('div');
                    listElement.className = 'list-item';
                    listElement.innerHTML = `
                        <div class="list-icon">${list.icon || 'üíë'}</div>
                        <div class="list-content">
                            <h3>${list.name}</h3>
                            <div class="list-meta">
                                <span><i class="far fa-calendar"></i> ${formatDate(list.createdAt)}</span>
                                ${list.createdBy ? `<span class="${creatorBadgeClass}"><i class="fas fa-user"></i> ${list.createdBy}</span>` : ''}
                            </div>
                            <div class="list-stats">
                                <span><i class="fas fa-check-circle"></i> ${completedCount}/${totalCount}</span>
                                <span><i class="fas fa-chart-line"></i> ${progress}%</span>
                                <span><i class="far fa-clock"></i> ${totalCount} items</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right arrow-icon"></i>
                    `;
                    
                    listElement.addEventListener('click', function() {
                        localStorage.setItem('currentListId', list.id);
                        window.location.href = 'list.html';
                    });
                    
                    listsContainer.appendChild(listElement);
                });
                
                emptyState.style.display = 'none';
            }

            // ==================== ADD NEW LIST ====================
            async function addNewList() {
                // Cek user sudah dipilih
                if (!userManager.getUser()) {
                    showToast('Pilih user dulu ya sayang! üíï');
                    userManager.showSelectionModal();
                    return;
                }
                
                const listName = newListInput.value.trim();
                if (!listName) {
                    showToast('Nama listnya ngga boleh kosong yaa sayanggg');
                    newListInput.focus();
                    return;
                }
                
                debugText.textContent = `Adding list: ${listName}`;
                
                // Save button state
                const originalText = addListBtn.innerHTML;
                const originalDisabled = addListBtn.disabled;
                
                try {
                    // Disable button
                    addListBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
                    addListBtn.disabled = true;
                    
                    // Prepare data dengan user info
                    const userInfo = userManager.getUserForDatabase();
                    const userDisplay = userManager.getUserForDisplay();
                    
                    const listData = {
                        name: listName,
                        sharedUserId: SHARED_USER_ID,
                        icon: listIcons[Math.floor(Math.random() * listIcons.length)],
                        items: [],
                        createdBy: userDisplay,
                        createdByDetails: {
                            type: userInfo.type,
                            emoji: userInfo.emoji,
                            deviceId: userInfo.deviceId
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastEditedBy: userDisplay
                    };
                    
                    debugText.textContent = 'Saving to Firebase...';
                    
                    // Save to Firebase
                    const docRef = await db.collection('lists').add(listData);
                    
                    debugText.textContent = `Saved with ID: ${docRef.id}`;
                    
                    // Add to local array
                    loadedLists.unshift({
                        id: docRef.id,
                        ...listData
                    });
                    
                    // Update UI
                    renderAllLists();
                    
                    // Clear input
                    newListInput.value = '';
                    showToast(`Yeayyy kerenn! List "${listName}" berhasil dibuat! ü•π`);
                    newListInput.focus();
                    
                    // Update sync indicator
                    syncIndicator.innerHTML = `<i class="fas fa-check-circle"></i> <span>${loadedLists.length} list ‚Ä¢ Updated</span>`;
                    
                    // Auto-refresh lists
                    setTimeout(loadListsSimple, 1000);
                    
                } catch (error) {
                    console.error("Error adding list:", error);
                    debugText.textContent = `Save error: ${error.code}`;
                    showToast(`Gagal menyimpan: ${error.message}`);
                    
                    // Restore button
                    addListBtn.innerHTML = originalText;
                    addListBtn.disabled = originalDisabled;
                }
            }

            // ==================== HELPER FUNCTIONS ====================
            function formatDate(timestamp) {
                if (!timestamp) return 'Baru saja';
                try {
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    if (isNaN(date.getTime())) return '-';
                    
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 1) return 'Baru saja';
                    if (diffMins < 60) return `${diffMins} menit lalu`;
                    if (diffMins < 1440) return `${Math.floor(diffMins/60)} jam lalu`;
                    
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'short'
                    });
                } catch (error) {
                    return '-';
                }
            }

            function showToast(message) {
                try {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('show');
                    
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                } catch (error) {
                    console.error("Toast error:", error);
                }
            }

            // ==================== EVENT LISTENERS ====================
            logoutBtn.addEventListener('click', function() {
                if (confirm('Yakin kamu mau keluar dari website ini sayanggg?')) {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('currentListId');
                    showToast('Sampai jumpa lagii sayangg, babayyyy!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            });

            addListBtn.addEventListener('click', addNewList);
            newListInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addNewList();
            });

            changeUserBtn.addEventListener('click', function() {
                userManager.changeUser();
            });

            // Auto-focus
            setTimeout(() => {
                newListInput.focus();
            }, 500);

            // ==================== INITIALIZE ====================
            debugText.textContent = 'Starting app...';
            
            // Initialize user
            checkUserSelection();
            
            // Load lists
            if (db) {
                loadListsSimple();
                
                // Set up auto-refresh every 10 seconds
                setInterval(() => {
                    loadListsSimple();
                }, 10000);
            } else {
                debugText.textContent = 'Firebase not initialized';
                showToast('Tidak bisa terhubung ke database');
            }
        });
    </script>
</body>
</html>
